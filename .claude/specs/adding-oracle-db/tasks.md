# Tasks: Oracle DB Integration

## Status: COMPLETED

All tasks have been implemented. See implementation notes below.

---

## Task Checklist

### Phase 1: Configuration

- [x] **Task 1.1** — Create `src/main/resources/application-oracle.properties`
  - Requirement: US-1 (Oracle Profile Activation)
  - Set `database=oracle`, datasource URL/user/pass with env var overrides, `spring.sql.init.mode=always`, `spring.sql.init.continue-on-error=true`

### Phase 2: SQL Scripts

- [x] **Task 2.1** — Create `src/main/resources/db/oracle/schema.sql`
  - Requirement: US-2 (Oracle Schema Initialization)
  - Oracle DDL: `NUMBER(4)`, `VARCHAR2(N)`, `GENERATED BY DEFAULT AS IDENTITY`, named indexes
  - Tables: `vets`, `specialties`, `vet_specialties`, `types`, `owners`, `pets`, `visits`

- [x] **Task 2.2** — Create `src/main/resources/db/oracle/data.sql`
  - Requirement: US-2 (Oracle Schema Initialization)
  - Idempotent seed data via `MERGE INTO ... USING DUAL ON (d.id = s.id)`
  - Sequence reset via `ALTER TABLE t MODIFY (id GENERATED BY DEFAULT AS IDENTITY (START WITH LIMIT VALUE))`
  - Seed: 6 vets, 3 specialties, 5 vet_specialty links, 6 types, 10 owners, 13 pets, 4 visits

### Phase 3: Maven Dependencies

- [x] **Task 3.1** — Add Oracle JDBC driver to `pom.xml`
  - Requirement: US-3 (Maven Dependency)
  - `com.oracle.database.jdbc:ojdbc11` at `runtime` scope (after PostgreSQL driver)
  - Version managed by Spring Boot 3.5.0 BOM

- [x] **Task 3.2** — Add Testcontainers Oracle module to `pom.xml`
  - Requirement: US-4 (Integration Test)
  - `org.testcontainers:oracle-xe` at `test` scope (after MySQL testcontainers dep)

### Phase 4: Integration Test

- [x] **Task 4.1** — Create `src/test/java/org/springframework/samples/petclinic/OracleIntegrationTests.java`
  - Requirement: US-4 (Integration Test)
  - Mirrors `MySqlIntegrationTests`: `@ActiveProfiles("oracle")`, `@Testcontainers(disabledWithoutDocker=true)`, `@ServiceConnection`, `OracleContainer` with `gvenzl/oracle-free:slim`
  - Tests: `testFindAll()`, `testOwnerDetails()`
  - Note: `OracleContainer` is not generic (no `<?>` type parameter)

### Phase 5: Documentation

- [x] **Task 5.1** — Update `CLAUDE.md`
  - Requirement: US-5 (Documentation Update)
  - Added Oracle run command to Build & Run Commands section
  - Added Oracle row to Database Profiles table
  - Added Oracle integration test entry to Testing section

### Phase 6: Spec Documents

- [x] **Task 6.1** — Create `.claude/specs/adding-oracle-db/design.md`
- [x] **Task 6.2** — Create `.claude/specs/adding-oracle-db/tasks.md`

---

## Verification Steps

```bash
# 1. Verify build compiles with Oracle driver on classpath
./mvnw package -DskipTests

# 2. Apply code formatter to new Java file
./mvnw spring-javaformat:apply

# 3. Run Oracle integration test (requires Docker)
./mvnw test -Dtest=OracleIntegrationTests

# 4. Manual smoke test (requires Oracle DB at localhost:1521)
./mvnw spring-boot:run -Dspring-boot.run.profiles=oracle
```

## Implementation Notes

- `OracleContainer` from `org.testcontainers:oracle-xe` is not a generic class — use `OracleContainer` (raw type), not `OracleContainer<?>`.
- `gvenzl/oracle-free:slim` is the lightweight Oracle Free 23ai Docker image (~2GB vs ~8GB for full XE).
- `spring.sql.init.continue-on-error=true` is set in `application-oracle.properties` (not the base `application.properties`) so it only applies to the Oracle profile.
- The `START WITH LIMIT VALUE` sequence reset at the end of `data.sql` is Oracle 12c+ syntax that advances the identity sequence to `max(existing_id) + 1`, preventing PK collisions on first application insert.
