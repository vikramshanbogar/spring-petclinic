# Design: Oracle DB Integration

## Architecture Overview

Oracle Database is added as a fourth supported Spring profile (`oracle`), following the identical convention used by MySQL and PostgreSQL. No application code changes are required — the integration is purely configuration and SQL scripts.

```mermaid
graph TD
    A[Spring Boot App] -->|profile=oracle| B[application-oracle.properties]
    B --> C[OracleDataSource\nojdbc11 driver]
    B --> D[spring.sql.init\nschema + data scripts]
    D --> E[db/oracle/schema.sql\nDDL - Oracle dialect]
    D --> F[db/oracle/data.sql\nSeed data - MERGE INTO DUAL]
    C --> G[(Oracle DB\nlocalhost:1521/petclinic)]
    H[OracleIntegrationTests] -->|@ServiceConnection| I[Testcontainers\ngvenzl/oracle-free:slim]
    I --> G
```

---

## Component Design

### 1. Spring Profile Properties (`application-oracle.properties`)

| Property | Value |
|----------|-------|
| `database` | `oracle` |
| `spring.datasource.url` | `${ORACLE_URL:jdbc:oracle:thin:@localhost:1521/petclinic}` |
| `spring.datasource.username` | `${ORACLE_USER:petclinic}` |
| `spring.datasource.password` | `${ORACLE_PASS:petclinic}` |
| `spring.sql.init.mode` | `always` |
| `spring.sql.init.continue-on-error` | `true` |

The `continue-on-error=true` setting compensates for Oracle lacking `CREATE TABLE IF NOT EXISTS` before version 23c — DDL errors on re-run (ORA-00955) are suppressed.

### 2. Oracle Schema (`db/oracle/schema.sql`)

Oracle-specific DDL differences from MySQL/PostgreSQL:

| Concern | MySQL | PostgreSQL | Oracle |
|---------|-------|-----------|--------|
| Auto-increment | `INT AUTO_INCREMENT` | `INT GENERATED BY DEFAULT AS IDENTITY` | `NUMBER(4) GENERATED BY DEFAULT AS IDENTITY` |
| String type | `VARCHAR(N)` | `TEXT` | `VARCHAR2(N)` |
| Integer type | `INT(4) UNSIGNED` | `INT` | `NUMBER(4)` |
| Idempotent DDL | `CREATE TABLE IF NOT EXISTS` | `CREATE TABLE IF NOT EXISTS` | Plain `CREATE TABLE` + `continue-on-error=true` |
| Named indexes | Inline `INDEX(col)` | `CREATE INDEX ON tbl(col)` | `CREATE INDEX name ON tbl(col)` |

### 3. Oracle Seed Data (`db/oracle/data.sql`)

Idempotent DML via `MERGE INTO ... USING DUAL ON (d.id = s.id)`:
- Explicit IDs are used for all seed rows (allowed by `GENERATED BY DEFAULT AS IDENTITY`)
- After seeding, identity sequences are reset with `ALTER TABLE t MODIFY (id GENERATED BY DEFAULT AS IDENTITY (START WITH LIMIT VALUE))` to prevent PK conflicts on subsequent application inserts

### 4. Maven Dependencies (`pom.xml`)

| Dependency | Scope | Purpose |
|------------|-------|---------|
| `com.oracle.database.jdbc:ojdbc11` | `runtime` | Oracle JDBC driver (version managed by Spring Boot BOM) |
| `org.testcontainers:oracle-xe` | `test` | Provides `OracleContainer` class for integration tests |

### 5. Integration Test (`OracleIntegrationTests.java`)

Mirrors `MySqlIntegrationTests` exactly:
- `@Testcontainers(disabledWithoutDocker = true)` — auto-skips without Docker
- `@ServiceConnection` on `OracleContainer` — Spring Boot auto-wires datasource URL/credentials
- Docker image: `gvenzl/oracle-free:slim` (lightweight Oracle Free edition)
- Tests: `testFindAll()` (verifies cache) + `testOwnerDetails()` (verifies HTTP 200 on `/owners/1`)

---

## Integration Points

- **`PetClinicRuntimeHints`**: Already registers `db/*` patterns — Oracle SQL files are covered automatically for GraalVM AOT
- **`BaseEntity`**: Uses `@GeneratedValue(strategy = GenerationType.IDENTITY)` — works natively with Oracle 12c+ identity columns, no changes needed
- **`application.properties`**: Drives `spring.sql.init.schema-locations=classpath*:db/${database}/schema.sql` — the `database=oracle` property in the profile properties file routes to the correct scripts automatically

---

## Key Design Decisions

1. **`continue-on-error=true` over PL/SQL blocks**: Avoids PL/SQL block delimiter conflicts with Spring's `;`-separated script executor while still supporting idempotent re-runs.

2. **`GENERATED BY DEFAULT AS IDENTITY` over sequences**: Consistent with PostgreSQL approach; works with `GenerationType.IDENTITY` without entity changes; allows explicit ID inserts in seed data.

3. **`START WITH LIMIT VALUE` sequence reset**: Prevents identity sequence collisions after explicit-ID seed inserts — Oracle-native syntax to advance the sequence to `max(id) + 1`.

4. **`gvenzl/oracle-free:slim`**: Lightweight Oracle Free (23ai) Docker image; officially supported by `OracleContainer` in testcontainers-java; avoids the large full Oracle XE image.
